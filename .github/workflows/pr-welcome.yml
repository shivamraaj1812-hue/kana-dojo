name: Welcome PR Authors

on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write
  contents: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.pull_request.head.ref, 'automation/') }}

    steps:
      - name: Post welcome comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const path = '.github/templates/messages.cjs';
            const ref = context.payload.pull_request.head.sha;
            const authorsPath = 'community/backlog/pr-authors.json';

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path,
              ref
            });

            if (!file || !file.content) {
              throw new Error('Could not load templates from repository content.');
            }

            const content = Buffer.from(file.content, 'base64').toString('utf8');
            const module = { exports: {} };
            const vm = require('vm');
            vm.runInNewContext(content, { module, exports: module.exports, require });
            const templates = module.exports;
            const t = templates.prWelcome;

            const pr = context.payload.pull_request;
            const author = pr.user.login;
            const authorKey = author.toLowerCase();

            let isFirstTime = true;
            let authors = [];
            let authorsSha = null;

            try {
              const { data: authorsFile } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: authorsPath
              });
              if (authorsFile && authorsFile.content) {
                const authorsContent = Buffer.from(authorsFile.content, 'base64').toString('utf8');
                const parsed = JSON.parse(authorsContent);
                authors = Array.isArray(parsed.authors) ? parsed.authors : [];
                authorsSha = authorsFile.sha || null;
              }
            } catch (e) {
              if (e.status !== 404) {
                console.log(`Could not load PR authors file: ${e.message}`);
              }
            }

            const normalized = new Set(authors.map(function(a) { return String(a).toLowerCase(); }));
            if (normalized.has(authorKey)) {
              isFirstTime = false;
            } else {
              authors.push(author);
            }

            const checklist = t.checklist.items.map(function(item) {
              return '- [ ] ' + item;
            }).join('\n');

            let welcomeMessage = `${t.greeting.replace('{author}', author)}\n\n${t.body}\n\n${t.checklist.title}\n${checklist}\n\n${t.footer}\n\n${t.thanks}`;

            if (isFirstTime) {
              welcomeMessage += `\n\n${t.firstTimeContributor.separator}\n\n${t.firstTimeContributor.title} ${t.firstTimeContributor.body}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: welcomeMessage
            });

            console.log(`Welcomed PR author @${author} on PR #${pr.number}`);

            if (!isFirstTime) {
              return;
            }

            const uniqueAuthors = Array.from(new Set(authors.map(function(a) { return String(a); }))).sort(function(a, b) {
              return a.localeCompare(b);
            });
            const payload = Buffer.from(JSON.stringify({ authors: uniqueAuthors }, null, 2) + '\n').toString('base64');

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: authorsPath,
              message: `chore(automation): track PR author ${author}`,
              content: payload,
              sha: authorsSha || undefined
            });
